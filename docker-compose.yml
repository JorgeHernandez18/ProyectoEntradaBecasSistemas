# ============================================
# Podman Compose para Sistema de Becarios UFPS
# Conecta a PostgreSQL existente en el servidor
# ============================================

version: '3.8'

services:
  # Aplicación PHP (conecta a PostgreSQL existente)
  becarios_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: becarios_app
    restart: unless-stopped
    env_file:
      - deployment/config/app.env
    environment:
      - TZ=America/Bogota
      - DB_HOST=host.containers.internal
    ports:
      - "${PORT_0}:80"
    volumes:
      # Fotos de becarios (persistente)
      - fotos_becarios:/app/admin/assets/fotos_becarios
      # Logs de la aplicación
      - logs_becarios:/var/log/becarios
      - logs_apache:/var/log/apache2
      # Archivos temporales
      - temp_uploads:/tmp/uploads
    extra_hosts:
      - "host.containers.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/vistas/formularios/index.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # pgAdmin para administración de BD (opcional, solo para desarrollo)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: becarios_pgadmin
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@becarios.ufps.edu.co
      - PGADMIN_DEFAULT_PASSWORD=admin123
      - PGADMIN_DISABLE_POSTFIX=true
    ports:
      - "${PORT_1}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    extra_hosts:
      - "host.containers.internal:host-gateway"
    profiles:
      - development

# Volúmenes nombrados para persistencia (sin PostgreSQL, usa BD externa)
volumes:
  pgadmin_data:
    name: becarios_pgadmin_data
    driver: local
  fotos_becarios:
    name: becarios_fotos
    driver: local
  logs_becarios:
    name: becarios_logs
    driver: local
  logs_apache:
    name: becarios_apache_logs
    driver: local
  temp_uploads:
    name: becarios_temp
    driver: local

# Red: Usando extra_hosts para acceso a PostgreSQL del servidor host